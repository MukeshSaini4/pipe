version: 0.2

env:
  variables:
    CONFIGURATION: "Release"
    PUBLISH_DIR: "output"
    DOTNET_VERSION: "8.0.405"

phases:
  install:
    commands:
      - Write-Host "Downloading dotnet-install script..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "Invoke-WebRequest 'https://dot.net/v1/dotnet-install.ps1' -OutFile dotnet-install.ps1"
      - Write-Host "Installing .NET $env:DOTNET_VERSION to C:\dotnet..."
      - powershell -NoProfile -ExecutionPolicy Bypass -File .\dotnet-install.ps1 -Version $env:DOTNET_VERSION -InstallDir C:\dotnet
      - Write-Host "Adding C:\dotnet to PATH and showing dotnet --info"
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "$env:PATH = 'C:\dotnet;' + $env:PATH; & 'C:\dotnet\dotnet.exe' --info"
      - Write-Host "Restoring packages..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "& 'C:\dotnet\dotnet.exe' restore"

  build:
    commands:
      - Write-Host "Building project(s)..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "& 'C:\dotnet\dotnet.exe' build -c $env:CONFIGURATION --no-restore"

  post_build:
    commands:
      - Write-Host "Publishing web projects to $env:PUBLISH_DIR..."
      - |
        powershell -NoProfile -ExecutionPolicy Bypass -Command "
          # define publish root and dist
          $pubRoot = Join-Path (Get-Location) $env:PUBLISH_DIR;
          if (-not (Test-Path $pubRoot)) { New-Item -ItemType Directory -Force -Path $pubRoot | Out-Null }

          Write-Host 'Publishing detected web projects to:' $pubRoot

          # Find web projects and publish them to $pubRoot
          Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
            try {
              if (Select-String -Path $_.FullName -Pattern 'Microsoft.NET.Sdk.Web' -Quiet) {
                Write-Host 'Publishing' $_.FullName;
                & 'C:\dotnet\dotnet.exe' publish $_.FullName -c $env:CONFIGURATION -o $pubRoot
              }
            } catch {
              Write-Host 'Publish error for' $_.FullName $_.Exception.Message
            }
          }

          Write-Host 'Publish phase complete.'
        "

      - Write-Host "Preparing CodeDeploy bundle (artifact.zip)..."
      - |
        powershell -NoProfile -ExecutionPolicy Bypass -Command "
          # set variables
          $pubRoot = Join-Path (Get-Location) $env:PUBLISH_DIR;
          $dist = Join-Path (Get-Location) 'dist';
          $appFolder = Join-Path $dist 'app';
          $scriptsDest = Join-Path $dist 'scripts';

          # cleanup previous dist
          if (Test-Path $dist) { Remove-Item -Recurse -Force -ErrorAction SilentlyContinue $dist }
          New-Item -ItemType Directory -Force -Path $appFolder | Out-Null;

          Write-Host 'Copying publish output from' $pubRoot 'to' $appFolder

          # copy all published output into dist\app
          if (Test-Path $pubRoot) {
            Copy-Item -Path (Join-Path $pubRoot '*') -Destination $appFolder -Recurse -Force -ErrorAction Stop;
          } else {
            Write-Host 'Warning: publish directory not found:' $pubRoot;
          }

          # copy appspec.yml if present
          if (Test-Path 'appspec.yml') {
            Copy-Item -Path 'appspec.yml' -Destination $dist -Force;
          } else {
            Write-Host 'Warning: appspec.yml not found in repo root.'
          }

          # copy scripts folder if present
          if (Test-Path 'scripts') {
            New-Item -ItemType Directory -Force -Path $scriptsDest | Out-Null;
            Copy-Item -Path (Join-Path 'scripts' '*') -Destination $scriptsDest -Recurse -Force;
          } else {
            Write-Host 'Warning: scripts folder not found in repo root.'
          }

          # ensure artifact.zip does not exist
          if (Test-Path artifact.zip) { Remove-Item artifact.zip -Force }

          Write-Host 'Compressing dist into artifact.zip...'
          Compress-Archive -Path (Join-Path $dist '*') -DestinationPath artifact.zip -Force

          Write-Host 'artifact.zip created.'
        "

artifacts:
  files:
    - artifact.zip
