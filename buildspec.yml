version: 0.2

env:
  variables:
    CONFIGURATION: "Release"
    PUBLISH_DIR: "output"
    DOTNET_VERSION: "8.0.405"

phases:
  install:
    commands:
      - Write-Host "Downloading dotnet-install script..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "Invoke-WebRequest 'https://dot.net/v1/dotnet-install.ps1' -OutFile dotnet-install.ps1"
      - Write-Host "Installing .NET $env:DOTNET_VERSION to C:\dotnet..."
      - powershell -NoProfile -ExecutionPolicy Bypass -File .\dotnet-install.ps1 -Version $env:DOTNET_VERSION -InstallDir C:\dotnet
      - Write-Host "Adding C:\dotnet to PATH and showing dotnet --info..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command " $env:PATH = 'C:\dotnet;' + $env:PATH; Start-Process -FilePath 'C:\dotnet\dotnet.exe' -ArgumentList '--info' -NoNewWindow -Wait"
      - Write-Host "Restoring packages..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "Start-Process -FilePath 'C:\dotnet\dotnet.exe' -ArgumentList 'restore' -NoNewWindow -Wait"

  build:
    commands:
      - Write-Host "Building project(s)..."
      - powershell -NoProfile -ExecutionPolicy Bypass -Command "Start-Process -FilePath 'C:\dotnet\dotnet.exe' -ArgumentList @('build','-c',$env:CONFIGURATION,'--no-restore') -NoNewWindow -Wait"

  post_build:
    commands:
      - Write-Host "Publishing web projects to $env:PUBLISH_DIR and preparing artifact..."
      - |
        powershell -NoProfile -ExecutionPolicy Bypass -Command "
          try {
            $pubRoot = Join-Path (Get-Location) $env:PUBLISH_DIR;
            if (-not (Test-Path $pubRoot)) { New-Item -ItemType Directory -Force -Path $pubRoot | Out-Null };
            Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object {
              if (Select-String -Path $_.FullName -Pattern 'Microsoft.NET.Sdk.Web' -Quiet) {
                Write-Host 'Publishing' $_.FullName;
                $outDir = Join-Path $pubRoot ($_.BaseName);
                Start-Process -FilePath 'C:\dotnet\dotnet.exe' -ArgumentList @('publish', $_.FullName, '-c', $env:CONFIGURATION, '-o', $outDir) -NoNewWindow -Wait
              }
            }

            # prepare dist folder and app subfolder
            $dist = Join-Path (Get-Location) 'dist';
            if (Test-Path $dist) { Remove-Item -Recurse -Force -ErrorAction SilentlyContinue $dist }
            New-Item -ItemType Directory -Force -Path (Join-Path $dist 'app') | Out-Null;

            # copy published output (all files/folders) from publish root into dist\app
            if (Test-Path $pubRoot) {
              Copy-Item -Path (Join-Path $pubRoot '*') -Destination (Join-Path $dist 'app') -Recurse -Force;
              Write-Host 'Copied publish output from' $pubRoot 'to' (Join-Path $dist 'app');
            } else {
              Write-Host 'Publish root not found:' $pubRoot;
            }

            # copy appspec.yml if it exists
            if (Test-Path 'appspec.yml') {
              Copy-Item -Path 'appspec.yml' -Destination $dist -Force;
              Write-Host 'Copied appspec.yml to' $dist;
            } else {
              Write-Host 'appspec.yml not found in repo root';
            }

            # copy scripts folder if it exists
            if (Test-Path 'scripts') {
              Copy-Item -Path 'scripts\\*' -Destination (Join-Path $dist 'scripts') -Recurse -Force;
              Write-Host 'Copied scripts to' (Join-Path $dist 'scripts');
            } else {
              Write-Host 'scripts folder not found in repo root';
            }

            # create artifact.zip at repo root containing contents of dist
            if (Test-Path 'artifact.zip') { Remove-Item 'artifact.zip' -Force };
            Write-Host 'Compressing dist into artifact.zip...';
            Compress-Archive -Path (Join-Path $dist '*') -DestinationPath 'artifact.zip' -Force;
            Write-Host 'artifact.zip created.';
            exit 0
          } catch {
            Write-Host 'ERROR preparing artifact:' $_.Exception.Message
            exit 1
          }
        "

artifacts:
  files:
    - artifact.zip
